
# Typing Coach — 本地端單人打字遊戲（弱點診斷＋自適應訓練）
**Date:** 2025‑09‑23  \**Version:** v0.1

## 目錄
- [TL;DR / Why now](#tldr--why-now)
- [Scope](#scope)
- [User Stories / JTBD](#user-stories--jtbd)
- [System Sketch](#system-sketch)
- [Data Model](#data-model)
- [Key Algorithms](#key-algorithms)
- [Frontend (Next.js + shadcn)](#frontend-nextjs--shadcn)
- [Gameplay Modes](#gameplay-modes)
- [Instrumentation & Metrics](#instrumentation--metrics)
- [Security & Privacy](#security--privacy)
- [Testing](#testing)
- [Release Plan](#release-plan)
- [Risks & Mitigations](#risks--mitigations)
- [Appendix](#appendix)
- [Next 3 Actions](#next-3-actions)

---

## TL;DR / Why now
- 目標：做一個**本地端**單人打字遊戲，能**即時分析弱點**（按鍵、雙鍵、n‑gram、常見錯字）、**自適應出題**，幫助玩家在 2 週內可測得明顯進步。
- v0 僅需瀏覽器即可離線運行；資料存於 `localStorage/IndexedDB`。
- 採用 **Next.js 15 + TypeScript + Tailwind + shadcn/ui**；演算法為 **EWMA 反應時間 + 混淆矩陣 + 失誤率加權**；排程以**間隔重複 (SR)**＋**弱點優先隊列**。

## Scope
### v0 (MVP 必要)
- 計時打字（30/60/120s）與段落抄打。
- 即時紀錄：WPM、KPM、準確率、Backspace 次數、每鍵反應時間 (RT)。
- 弱點診斷：
  - **Key‑Level**：各鍵錯誤率、RT 百分位。
  - **Bigram**（連續兩鍵）錯誤率/延遲。
  - **Confusion Matrix**：實際鍵 vs. 錯打鍵（Top‑5）。
- 自適應出題：根據弱點自動生成練習串（含字詞、bigram drills、單鍵練習）。
- 本地資料儲存、可重置、可匯出 JSON。

### v1 (增強)
- 帳號（仍離線、僅本機多檔案檔案制）。
- 中文/英文模式、標點/數字練習切換。
- 自訂詞庫（技術英文、程式碼符號集）。
- 目標導向訓練（例如「把 A 鍵 RT 壓到 < 180ms」）。

### v2 (進階)
- ELO 難度模型、地圖式闖關、每日挑戰。
- 盲打課程路徑、鍵位熱圖動畫、手指負載圖。
- A/B 任務生成器：比較不同訓練菜單成效。

### In Scope & 假設
- 純前端，無伺服器。Chrome/Edge/Safari 新版可跑。
- 鍵盤佈局預設 QWERTY（可擴充）。

### Out of Scope
- 線上多人、雲同步、手機佈局支援（首版不做）。

## User Stories / JTBD
1. **As a learner**，我想快速知道**哪些鍵/雙鍵最慢**，以便集中練。
   - ✅ 驗收：結果頁顯示 Top‑5 慢鍵、慢雙鍵與百分位。
2. **As a gamer**，我想要**動態出題**，每回合都練到最弱項。
   - ✅ 驗收：每回合題目包含 ≥60% 來源於個人 Top‑10 弱點。
3. **As a data‑driven user**，我想看**趨勢圖**（7 天、30 天）。
   - ✅ 驗收：RT/WPM/Acc 折線與每鍵箱型圖。
4. **As a busy student**，我想要**5 分鐘 quick drill**。
   - ✅ 驗收：一鍵開始 5 分鐘弱點菜單。

## System Sketch
- **Frontend**：Next.js App Router；shadcn/ui（Card、Tabs、Dialog、Progress、Table）。
- **State**：Zustand/Context（遊戲進行中統計＋離線資料管理）。
- **Storage**：`localStorage`（設定/最近會話）＋`IndexedDB`（歷史事件流）。
- **Logic**：
  - `engine/keystats.ts`：事件→特徵。
  - `engine/weakness.ts`：弱點分數（鍵、bigram、n‑gram、混淆）。
  - `engine/scheduler.ts`：自適應出題。

## Data Model
### TypeScript 型別（摘要）
```ts
type KeyCode = string;       // e.g., "KeyA","Space","Comma"
type Timestamp = number;     // performance.now()

export type Keystroke = {
  ts: Timestamp;
  expected: KeyCode | null;  // null=自由輸入模式
  received: KeyCode;
  correct: boolean;
  latencyMs: number;         // 與前次鍵/或目標字元的間隔
  backspace?: boolean;
};

export type KeyStat = {
  code: KeyCode;
  hits: number;
  errors: number;
  avgRt: number;
  ewmaRt: number;            // 指數加權移動平均
};

export type Bigram = `${KeyCode}>${KeyCode}`;
export type BigramStat = { bigram: Bigram; hits: number; errors: number; ewmaRt: number; };

export type ConfusionKey = `${KeyCode}|${KeyCode}`; // expected|received
export type ConfusionStat = { pair: ConfusionKey; count: number };

export type Session = {
  id: string;
  startedAt: number;
  durationSec: number;
  mode: "timed" | "paragraph" | "drill";
  wpm: number;
  accuracy: number;
  totalKeystrokes: number;
  keystrokes: Keystroke[];   // 可裁剪保存
};

export type Profile = {
  layout: "QWERTY";
  keyStats: Record<KeyCode, KeyStat>;
  bigramStats: Record<Bigram, BigramStat>;
  confusion: Record<ConfusionKey, ConfusionStat>;
  history: string[];         // session ids
  goals?: { key?: KeyCode; targetRtMs?: number }[];
};
```

### IndexedDB 表
- `sessions`: `Session`
- `profiles`: 單一文件，持久化 `Profile`（或按日期分段）

## Key Algorithms
### 1) 反應時間 EWMA
- 以 α=0.3（可調）計算 `ewmaRt := α·rt + (1-α)·prevEwmaRt`。
- 以**鍵位基準**建立 RT 百分位（全域常模 or 本地歷史）。

### 2) 弱點分數 (Weakness Score, WS)
對每個鍵/雙鍵計算：
```
errRate = errors / max(1, hits)
rtZ    = (ewmaRt - rtMean) / rtStd
WS     = w1*errRate + w2*sigmoid(rtZ) + w3*recencyBoost
```
- 預設 `(w1,w2,w3)=(0.6,0.3,0.1)`；`recencyBoost` 對最近 24h 的錯誤加權。

### 3) 混淆矩陣（錯打統計）
- 將 `expected|received` 聚合成 Top‑N 清單。
- 針對混淆對（如 `KeyO|KeyP`）生成針對性字串：「op」「po」「o p」「;p」。

### 4) 自適應出題 Scheduler
- 目標：**每回合 20~40% 新挑戰 + 60~80% 弱點修補**。
- 優先佇列：以 `WS` 排序，抽樣比例 ~ `softmax(WS/τ)`，`τ≈0.5`。
- 生成策略：
  1. 單鍵 drill（高錯誤鍵）：`aaaa ssss a s a s …`
  2. Bigram drill（高 WS 的 bigram）：`as sa as sa …`
  3. 單詞/片段生成：貪婪拼接包含目標 bigram 的詞（內建詞庫）。

### 5) 會話評估與回饋
- **目標鍵**：若過去 3 回合 `ewmaRt` 下降 ≥10% 且錯誤率 < 2%，提升難度或降權重。
- **停滯偵測**：兩週趨勢平坦 → 建議姿勢/鍵盤練習或改換模式。

## Frontend (Next.js + shadcn)
### 目錄骨架
```
app/
  (app)/
    page.tsx              # 儀表板（今日進度、弱點Top5）
    play/page.tsx         # 遊戲畫面（輸入框、倒數、進度條）
    review/page.tsx       # 結果分析（圖表＋建議）
  api/                    # (無後端；可保留空資料夾)
components/
  stats/KeyHeatmap.tsx
  charts/TrendChart.tsx
engine/
  keystats.ts
  weakness.ts
  scheduler.ts
lib/
  db.ts                   # IndexedDB/localStorage helpers
```

### 關鍵元件與交互
- `PlayPanel`：監聽 `keydown`，產生 `Keystroke` 事件流。
- `LiveHUD`：即時顯示 WPM/Acc/剩餘時間。
- `ResultInsights`：弱點 Top‑N、混淆 Top‑N、建議菜單（可一鍵開始）。

### 範例：事件處理與更新（簡化）
```ts
// engine/keystats.ts
export function updateKeyStats(stats: Record<string, KeyStat>, k: Keystroke) {
  const code = k.expected ?? k.received;
  const s = stats[code] ?? { code, hits: 0, errors: 0, avgRt: 0, ewmaRt: 220 };
  s.hits += 1;
  if (!k.correct) s.errors += 1;
  s.avgRt = s.avgRt + (k.latencyMs - s.avgRt) / s.hits;
  const alpha = 0.3;
  s.ewmaRt = alpha * k.latencyMs + (1 - alpha) * s.ewmaRt;
  stats[code] = s;
}
```

```ts
// engine/weakness.ts
export function weaknessScore(s: KeyStat, rtMean=210, rtStd=40) {
  const errRate = s.errors / Math.max(1, s.hits);
  const rtZ = (s.ewmaRt - rtMean) / Math.max(1, rtStd);
  const sigmoid = (z:number)=>1/(1+Math.exp(-z));
  return 0.6*errRate + 0.3*sigmoid(rtZ) + 0.1*Math.min(1, s.errors/20);
}
```

```ts
// engine/scheduler.ts (以鍵位為例)
export function buildDrill(profile: Profile, n=60): string {
  const arr = Object.values(profile.keyStats);
  arr.sort((a,b)=> weaknessScore(b)-weaknessScore(a));
  const pool = arr.slice(0, 10).flatMap(s => s.code);
  // 轉回可見字符（簡化示例）
  const toChar = (code:string) => code.startsWith("Key")? code[3].toLowerCase() : " ";
  let out = "";
  for (let i=0;i<n;i++) out += toChar(pool[Math.floor(Math.random()*pool.length)]);
  return out;
}
```

## Gameplay Modes
- **診斷 (3–5 分鐘)**：快速蒐集基線資料，建立個人常模。
- **修補 (Drill)**：根據弱點池生成題組（單鍵/雙鍵/詞組）。
- **測驗 (Test)**：固定長度段落，檢查 WPM/Acc/RT 趨勢與轉移。

## Instrumentation & Metrics
- **核心**：WPM、Accuracy、Median RT、95p RT、Backspace/100 keys。
- **弱點指標**：鍵/雙鍵 WS、混淆對次數、會話後 WS 變化 Δ。
- **目標**：7 日移動平均 WPM ↑≥10%，Top‑5 WS ↓≥30%。

## Security & Privacy
- 全部在本機；不上傳。允許一鍵匯出/刪除資料。

## Testing
- **單元**：
  - keystats：EWMA、avgRt 更新、錯誤率。
  - weakness：WS 單調性（錯誤率↑→WS↑）。
  - scheduler：Top‑10 鍵涵蓋率 ≥60%。
- **E2E（Playwright）**：模擬 keydown 流、回合結束、結果檢查。

## Release Plan
- `next build && next export` 產生純靜態，直接丟 GitHub Pages 或本地檔案伺服器。
- 無環境變數需求。提供 `seed.json` 匯入以便展示。

## Risks & Mitigations
- **噪音鍵入（非人為延遲）**：以中位數＋IQR 濾除極端 RT。
- **中文/英文切換**：v0 建議先英文；中文需處理詞切分與注音/倉頡差異。
- **佈局差異**：QWERTY 先行，之後再支援 Dvorak/Colemak。

## Appendix
### README.md（可貼入專案）
```md
# Typing Coach (Local First)
- Next.js 15 + TS + Tailwind + shadcn
- Local only: IndexedDB for history, localStorage for settings

## Run
pnpm i
pnpm dev

## Build (static export)
pnpm build
pnpm export

## Files
- engine/keystats.ts  // event → stats
- engine/weakness.ts  // weakness score
- engine/scheduler.ts // adaptive drills
```

### Seed & Fixtures（簡例）
```json
{
  "profile": {
    "layout": "QWERTY",
    "keyStats": {
      "KeyA": {"code":"KeyA","hits":120,"errors":9,"avgRt":230,"ewmaRt":240},
      "KeyS": {"code":"KeyS","hits":90,"errors":11,"avgRt":245,"ewmaRt":255}
    },
    "bigramStats": {},
    "confusion": {"KeyO|KeyP":{"pair":"KeyO|KeyP","count":7}},
    "history": []
  }
}
```

### UI Wireframe（ASCII）
```
+----------------------------------------------------------+
|  Typing Coach     Today: 5m   WPM 52   Acc 93%          |
+----------------------------------------------------------+
| [Start Quick Drill] [Test 60s] [Paragraph]               |
+---------------------------+------------------------------+
| Weakest Keys              | Confusions                   |
| A (WS 0.41)  S (0.39)     | O→P x7, ;→' x3              |
| L (0.33)     C (0.30)     |                              |
+---------------------------+------------------------------+
| Trend (7d): WPM ↑         | Goals: A RT < 180ms          |
+----------------------------------------------------------+
```

## Next 3 Actions
1. 建新 repo，初始化 Next.js + Tailwind + shadcn（含 `engine/*` 檔）。
2. 完成 `PlayPanel` 事件流與 `keystats.ts` 更新邏輯（可先 console 檢查）。
3. 實作 `weakness.ts` + `scheduler.ts`，在結果頁生成 Top‑N 與一鍵開始 Drill。
